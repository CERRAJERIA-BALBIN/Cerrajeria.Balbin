<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>C&B Cerrajería Balbín - Socio</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: radial-gradient(circle at top, #0b0c10, #1f2833);
      color: #f1f1f1;
      text-align: center;
      padding: 40px;
    }
    h1 {
      color: #e0b84e;
      font-size: 2em;
    }
    .card {
      border: 2px solid #e0b84e;
      border-radius: 15px;
      padding: 20px;
      margin: 20px auto;
      width: 320px;
      background: rgba(255, 255, 255, 0.05);
      text-align: left;
    }
    footer {
      margin-top: 40px;
      font-size: 0.9em;
      color: #aaa;
    }
  </style>
</head>
<body>
  <h1>C&B Cerrajería Balbín</h1>
  <p>Membresía Digital</p>

  <div class="card">
    <h2>Datos del Socio</h2>
    <p><strong>Nombre:</strong> <span id="nombre">...</span></p>
    <p><strong>N° Socio:</strong> <span id="numero">...</span></p>
    <p><strong>Plan:</strong> <span id="plan">...</span></p>
    <p><strong>Estado de Pago:</strong> <span id="estado">...</span></p>
  </div>

  <div class="card">
    <h2>Últimos 3 Servicios</h2>
    <ul id="servicios">
      <li>Cargando...</li>
    </ul>
  </div>

  <footer>
    <p>Av. Balbín 1377 - Tandil</p>
    <p>Tel: 2494240906</p>
  </footer>

<script>
  // Enlaces a tus hojas CSV publicadas
  var SOCIOS_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRQqKxPsd9noQiLmoq4qG6YUvxP-bamjSYCc54KcR67aJilqTSVJmYWRH844FS3jZRrN-jN3Kc3R40k/pub?gid=0&single=true&output=csv";
  var SERVICIOS_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRQqKxPsd9noQiLmoq4qG6YUvxP-bamjSYCc54KcR67aJilqTSVJmYWRH844FS3jZRrN-jN3Kc3R40k/pub?gid=1745929313&single=true&output=csv";
  var PROXY = "https://api.allorigins.win/raw?url=";

  function fetchCSV(url, callback) {
    fetch(PROXY + encodeURIComponent(url))
      .then(function(res) { return res.text(); })
      .then(function(text) {
        var rows = text.trim().split(/\r?\n/);
        var headers = rows.shift().split(",");
        var data = rows.map(function(row) {
          var values = row.split(",");
          var obj = {};
          for (var i = 0; i < headers.length; i++) {
            obj[headers[i].trim()] = (values[i] || "").trim();
          }
          return obj;
        });
        console.log("Leído:", data.length, "filas de", url);
        callback(data);
      })
      .catch(function(err) {
        console.error("Error cargando CSV:", err);
        callback([]);
      });
  }

  function main() {
    var params = new URLSearchParams(window.location.search);
    var socioId = params.get("id");
    console.log("Buscando socio ID:", socioId);

    if (!socioId) {
      document.getElementById("servicios").innerHTML = "<li>Falta ID en la URL</li>";
      return;
    }

    fetchCSV(SOCIOS_URL, function(socios) {
      var socio = null;
      for (var i = 0; i < socios.length; i++) {
        if (socios[i]["N° Socio"] === socioId) {
          socio = socios[i];
          break;
        }
      }

      if (socio) {
        document.getElementById("nombre").textContent = socio["Nombre"] || "";
        document.getElementById("numero").textContent = socio["N° Socio"] || "";
        document.getElementById("plan").textContent = socio["Plan"] || "";
        document.getElementById("estado").textContent = socio["Estado de Pago"] || "";
      } else {
        document.getElementById("nombre").textContent = "No encontrado";
      }

      // Ahora cargamos los servicios
      fetchCSV(SERVICIOS_URL, function(servicios) {
        var lista = document.getElementById("servicios");
        lista.innerHTML = "";
        var encontrados = [];
        for (var j = 0; j < servicios.length; j++) {
          if (servicios[j]["N° Socio"] === socioId) {
            encontrados.push(servicios[j]);
          }
        }

        if (encontrados.length > 0) {
          var ultimos = encontrados.slice(-3);
          for (var k = 0; k < ultimos.length; k++) {
            var s = ultimos[k];
            var texto = "";
            var campos = ["Servicio [Apertura]", "Servicio [Reparación]", "Servicio [Lubricación preventiva]", "Servicio [Cambio de cerradura]", "Dirección"];
            for (var c = 0; c < campos.length; c++) {
              if (s[campos[c]] && s[campos[c]].length > 0) {
                texto += (texto ? " | " : "") + s[campos[c]];
              }
            }
            var li = document.createElement("li");
            li.textContent = texto || "Servicio registrado";
            lista.appendChild(li);
          }
        } else {
          lista.innerHTML = "<li>Sin servicios registrados</li>";
        }
      });
    });
  }

  main();
</script>
</body>
</html>
