<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>C&B Cerrajería Balbín - Socio</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: radial-gradient(circle at top, #0b0c10, #1f2833);
    color: #f1f1f1;
    text-align: center;
    padding: 40px;
  }
  h1 {
    color: #e0b84e;
  }
  .card {
    border: 2px solid #e0b84e;
    border-radius: 15px;
    padding: 20px;
    margin: 20px auto;
    width: 320px;
    background: rgba(255,255,255,0.05);
    text-align: left;
  }
  .direccion {
    margin-top: 10px;
    font-size: 0.9em;
    color: #ccc;
    white-space: pre-line;
  }
  footer {
    margin-top: 40px;
    font-size: 0.9em;
    color: #aaa;
  }
</style>
</head>
<body>

<h1>Carnet Digital del Socio</h1>

<div class="card">
  <h2>Datos del Socio</h2>
  <p><strong>Nombre:</strong> <span id="nombre">...</span></p>
  <p><strong>N° Socio:</strong> <span id="numero">...</span></p>
  <p><strong>Plan:</strong> <span id="plan">...</span></p>
  <p><strong>Estado de Pago:</strong> <span id="estado">...</span></p>
</div>

<div class="card">
  <h2>Últimos Servicios Utilizados</h2>
  <div id="servicios">Cargando...</div>
</div>

<footer>
  <p>C&B Cerrajería Balbín - Av. Balbín 1377 - Tandil</p>
  <p>Contacto: 2494 240906</p>
</footer>

<script>
const SOCIOS_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRQqKxPsd9noQiLmoq4qG6YUvxP-bamjSYCc54KcR67aJilqTSVJmYWRH844FS3jZRrN-jN3Kc3R40k/pub?gid=0&single=true&output=csv";
const SERVICIOS_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRQqKxPsd9noQiLmoq4qG6YUvxP-bamjSYCc54KcR67aJilqTSVJmYWRH844FS3jZRrN-jN3Kc3R40k/pub?gid=1745929313&single=true&output=csv";
const PROXY = "https://api.allorigins.win/raw?url=";

function fetchCSV(url) {
  return fetch(PROXY + encodeURIComponent(url))
    .then(res => res.text())
    .then(text => {
      const [header, ...lines] = text.trim().split(/\r?\n/);
      const keys = header.split(",");
      return lines.map(line => {
        const values = line.split(",");
        const obj = {};
        keys.forEach((k, i) => obj[k.trim()] = (values[i] || "").trim());
        return obj;
      });
    });
}

async function main() {
  const id = new URLSearchParams(window.location.search).get("id");
  if (!id) return document.getElementById("servicios").textContent = "Falta ID en la URL";

  const socios = await fetchCSV(SOCIOS_URL);
  const socio = socios.find(s => s["N° Socio"] === id);
  if (!socio) return document.getElementById("servicios").textContent = "Socio no encontrado";

  document.getElementById("nombre").textContent = socio["Nombre"];
  document.getElementById("numero").textContent = socio["N° Socio"];
  document.getElementById("plan").textContent = socio["Plan"];
  document.getElementById("estado").textContent = socio["Estado de Pago"];

  const servicios = await fetchCSV(SERVICIOS_URL);
  const propios = servicios.filter(s => s["N° Socio"] === id);

  if (!propios.length) return document.getElementById("servicios").textContent = "Sin servicios registrados";

  const campos = [
    "Servicio [Apertura]",
    "Servicio [Reparación]",
    "Servicio [Lubricacion preventiva]",
    "Servicio [Cambio de cerradura]"
  ];

  let resumen = [];
  let extras = [];

  propios.forEach(s => {
    campos.forEach(c => {
      if (s[c]) resumen.push(${c.replace("Servicio [","").replace("]","")} ${s[c]});
    });
    if (s["Dirección"]) extras.push(s["Dirección"]);
  });

  const div = document.getElementById("servicios");
  div.innerHTML = resumen.join(" | ");
  if (extras.length) {
    const dire = document.createElement("div");
    dire.className = "direccion";
    dire.textContent = "Direcciones / Datos:\n" + extras.join("\n");
    div.appendChild(dire);
  }
}

main();
</script>

</body>
</html>
